---
import "../styles/global.css";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import { site, absoluteUrl } from "../config/site";

const {
  title,
  description,
  pathname = Astro.url.pathname,
  image = "/uploads/og-cover.png",
  noindex = false,
} = Astro.props;

const canonical = absoluteUrl(pathname);
const ogImage = image.startsWith("http") ? image : absoluteUrl(image);

const jsonLd = {
  "@context": "https://schema.org",
  "@type": "AutoDealer",
  name: site.name,
  url: site.url,
  address: {
    "@type": "PostalAddress",
    streetAddress: site.address.street,
    postalCode: site.address.zip,
    addressLocality: site.address.city,
    addressCountry: site.address.country,
  },
  telephone: site.phones,
};
---
<!doctype html>
<html lang="de">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content={site.brandColor} />

    <title>{title}</title>
    {description && <meta name="description" content={description} />}

    <link rel="canonical" href={canonical} />
    {noindex && <meta name="robots" content="noindex,nofollow" />}

    <!-- Open Graph -->
    <meta property="og:locale" content={site.locale} />
    <meta property="og:type" content="website" />
    <meta property="og:title" content={title} />
    {description && <meta property="og:description" content={description} />}
    <meta property="og:url" content={canonical} />
    <meta property="og:site_name" content={site.name} />
    <meta property="og:image" content={ogImage} />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    {description && <meta name="twitter:description" content={description} />}
    <meta name="twitter:image" content={ogImage} />

    <script type="application/ld+json">
      {JSON.stringify(jsonLd)}
    </script>
  </head>
  <body>
    <Header />
    <main class="container" style="padding-top:22px;">
      <slot />
    </main>
    <Footer />

    <script>
      function setExpanded(root, expanded) {
        const btn = root.querySelector(".cselect__btn");
        if (btn) btn.setAttribute("aria-expanded", expanded ? "true" : "false");
      }
    
      function closeAll(except = null) {
        document.querySelectorAll("[data-cselect]").forEach((root) => {
          if (root !== except) {
            root.classList.remove("is-open");
            setExpanded(root, false);
          }
        });
      }
    
      document.addEventListener("click", (e) => {
        const target = e.target;
    
        // Falls Klick außerhalb eines Custom Selects: nur schließen, sonst nichts
        const root = target.closest?.("[data-cselect]");
        if (!root) {
          closeAll(null);
          return;
        }
    
        const btn = root.querySelector(".cselect__btn");
        const hidden = root.querySelector('input[type="hidden"]');
        const btnText = root.querySelector(".cselect__btnText");
    
        // Button klick -> Toggle
        if (target.closest(".cselect__btn")) {
          const willOpen = !root.classList.contains("is-open");
          closeAll(root);
          root.classList.toggle("is-open", willOpen);
          setExpanded(root, willOpen);
          return;
        }
    
        // Option klick -> Wert setzen
        const opt = target.closest(".cselect__opt");
        if (opt && hidden && btnText) {
          hidden.value = opt.dataset.value ?? "";
          btnText.textContent = opt.textContent.trim();
    
          root.querySelectorAll(".cselect__opt").forEach((li) => li.classList.remove("is-selected"));
          opt.classList.add("is-selected");
    
          root.classList.remove("is-open");
          setExpanded(root, false);
          return;
        }
      });
    
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") closeAll(null);
      });
    </script>
    
    
  </body>
</html>
