---
import BaseLayout from "../../layouts/BaseLayout.astro";
import autosData from "../../data/cars.json";
import { site, telHref } from "../../config/site.js";

export function getStaticPaths() {
  const autos = Array.isArray(autosData) ? autosData : (autosData?.default ?? []);
  return autos.map((auto: any) => ({ params: { id: String(auto.id) } }));
}

const autos = Array.isArray(autosData) ? autosData : (autosData?.default ?? []);
const { id } = Astro.params;
const auto = autos.find((a: any) => String(a.id) === String(id));

const bilder = (auto?.bilder ?? []) as string[];
const details: any = auto?.details ?? {};
const ausstattung: string[] = Array.isArray(details?.ausstattung) ? details.ausstattung : [];
const beschreibung: string = details?.beschreibung ?? "";


const title = auto
  ? `${auto.titel} – ${site.name}`
  : `Fahrzeug nicht gefunden – ${site.name}`;

const description = auto
  ? `${auto.titel}: ${Number(auto.preis).toLocaleString("de-DE")} € · ${Number(auto.km).toLocaleString("de-DE")} km · EZ ${auto.ez}.`
  : "Dieses Fahrzeug wurde nicht gefunden.";
---

<BaseLayout title={title} description={description}>
  {!auto && (
    <section class="card" style="padding:18px;">
      <h1 class="h1">Fahrzeug nicht gefunden</h1>
      <p class="p">Der Link stimmt eventuell nicht mehr.</p>
      <a class="btn primary" href="/fahrzeuge/">Zur Übersicht</a>
    </section>
  )}

  {auto && (
    <>
      <div style="display:flex;justify-content:space-between;gap:14px;flex-wrap:wrap;align-items:flex-end;">
        <div>
          <a class="small" href="/fahrzeuge/" style="text-decoration:none;opacity:.85;">← Zurück zur Übersicht</a>
          <h1 class="h1" style="margin-top:10px;">{auto.titel}</h1>
          <div class="small" style="margin-top:8px;">
            {Number(auto.km).toLocaleString("de-DE")} km · EZ {auto.ez}
            {auto.status === "reserviert" && <span style="margin-left:10px;" class="chip">Reserviert</span>}
            {auto.status === "verkauft" && <span style="margin-left:10px;" class="chip">Verkauft</span>}
          </div>
        </div>

        <div style="text-align:right;">
          <div class="small">Preis</div>
          <div style="font-size:28px;font-weight:900;">{Number(auto.preis).toLocaleString("de-DE")} €</div>
        </div>
      </div>

      
      <section class="detail-layout" style="margin-top:16px;">
        <div class="detail-main">
          <div class="card" style="overflow:hidden;">
            {bilder?.length ? (
              <div class="gallery">
                <button class="gallery-main" type="button" data-lightbox-open aria-label="Bild vergrößern">
                  <img
                    id="mainImage"
                    src={bilder[0]}
                    alt={auto.titel}
                    loading="eager"
                    decoding="async"
                  />
                  <span class="gallery-hint">Klicken zum Vergrößern</span>
                </button>

                {bilder.length > 1 && (
                  <div class="gallery-thumbs" aria-label="Weitere Bilder">
                    {bilder.map((src: string, i: number) => (
                      <button
                        class={"thumb" + (i === 0 ? " is-active" : "")}
                        type="button"
                        data-thumb-index={i}
                        aria-label={`Bild ${i + 1} auswählen`}
                      >
                        <img src={src} alt={`${auto.titel} – Bild ${i + 1}`} loading="lazy" decoding="async" />
                      </button>
                    ))}
                  </div>
                )}
              </div>
            ) : (
              <div class="small" style="padding:14px;">Keine Bilder vorhanden.</div>
            )}
          </div>

          <div class="card" style="padding:16px;margin-top:14px;">
            <h2 class="h2">Highlights</h2>

            <div class="spec-grid" style="margin-top:10px;">
              <div class="spec"><div class="k">Leistung</div><div class="v">{details?.leistung_kw ? `${details.leistung_kw} kW (${details.leistung_ps ?? ""} PS)` : "—"}</div></div>
              <div class="spec"><div class="k">Erstzulassung</div><div class="v">{auto.ez ?? "—"}</div></div>
              <div class="spec"><div class="k">KM-Stand</div><div class="v">{Number(auto.km).toLocaleString("de-DE")} km</div></div>
              <div class="spec"><div class="k">Getriebe</div><div class="v">{auto.getriebe ?? "—"}</div></div>
              <div class="spec"><div class="k">Kraftstoff</div><div class="v">{auto.kraftstoff ?? "—"}</div></div>
              <div class="spec"><div class="k">Farbe</div><div class="v">{details?.farbe ?? "—"}</div></div>
            </div>
          </div>

          {(beschreibung || ausstattung.length) && (
            <div class="card" style="padding:16px;margin-top:14px;">
              {beschreibung && (
                <>
                  <h2 class="h2">Beschreibung</h2>
                  <p style="margin-top:10px;line-height:1.7;">{beschreibung}</p>
                </>
              )}

              {ausstattung.length ? (
                <>
                  <h2 class="h2" style="margin-top:beschreibung ? '18px' : '0'}">Ausstattung</h2>

                  <ul class="equip-list" data-equip-list style="margin-top:10px;">
                    {ausstattung.map((item: string, i: number) => (
                      <li class={i > 11 ? "is-hidden" : ""}>{item}</li>
                    ))}
                  </ul>

                  {ausstattung.length > 12 && (
                    <button class="btn" type="button" data-equip-toggle style="margin-top:12px;">
                      Mehr anzeigen
                    </button>
                  )}
                </>
              ) : null}
            </div>
          )}
        </div>

        <aside class="detail-side">
          <div class="card sticky" style="padding:16px;">
            <div class="small">Preis</div>
            <div class="price">{Number(auto.preis).toLocaleString("de-DE")} €</div>
            <div class="small" style="margin-top:6px;opacity:.85;">inkl. MwSt. (falls ausweisbar)</div>

            <div class="divider"></div>

            <ul class="side-list">
              <li><b>Fahrzeug-Nr.:</b> {auto.id}</li>
              <li><b>Status:</b> {auto.status}</li>
              {details?.fahrzeugart && <li><b>Art:</b> {details.fahrzeugart}</li>}
              {details?.karosserie && <li><b>Karosserie:</b> {details.karosserie}</li>}
              {details?.antrieb && <li><b>Antrieb:</b> {details.antrieb}</li>}
              {details?.hu && <li><b>HU:</b> {details.hu}</li>}
              {details?.vorbesitzer != null && <li><b>Vorbesitzer:</b> {details.vorbesitzer}</li>}
              {details?.standort && <li><b>Standort:</b> {details.plz ? `${details.plz} ` : ""}{details.standort}</li>}
            </ul>

            <div class="divider"></div>

            <h2 class="h2">Interesse?</h2>
            <p class="small" style="margin-top:8px;">
              Ruf uns an oder schreib uns über das Kontaktformular. Bitte nenne dabei die Fahrzeug-ID:
              <b> {auto.id}</b>
            </p>

            <div style="display:flex;flex-direction:column;gap:10px;margin-top:12px;">
              <a class="btn primary" href="/kontakt/">Kontaktformular öffnen</a>
              {site.phones?.[0] && <a class="btn" href={telHref(site.phones[0])}>{site.phones[0]}</a>}
              {site.phones?.[1] && <a class="btn" href={telHref(site.phones[1])}>{site.phones[1]}</a>}
            </div>
          </div>
        </aside>
      </section>

      <div class="lightbox" data-lightbox aria-hidden="true">
        <div class="lightbox-backdrop" data-lightbox-close></div>
        <div class="lightbox-panel" role="dialog" aria-modal="true" aria-label="Bildvorschau">
          <button class="lightbox-close" type="button" data-lightbox-close aria-label="Schließen">×</button>
          <button class="lightbox-nav prev" type="button" data-lightbox-prev aria-label="Vorheriges Bild">‹</button>
          <img class="lightbox-img" data-lightbox-img alt="Bildvorschau" />
          <button class="lightbox-nav next" type="button" data-lightbox-next aria-label="Nächstes Bild">›</button>
          <div class="lightbox-count small" data-lightbox-count></div>
        </div>
      </div>

    </>
  )}

<style>
  .detail-layout{display:grid;grid-template-columns:1.6fr 1fr;gap:16px;align-items:start}
  @media (max-width: 980px){.detail-layout{grid-template-columns:1fr}.detail-side .sticky{position:static}}
  .gallery{display:flex;flex-direction:column;gap:10px;padding:12px}
  .gallery-main{position:relative;border:0;background:transparent;padding:0;cursor:zoom-in}
  .gallery-main img{width:100%;height:min(56vh,520px);object-fit:cover;border-radius:16px;border:1px solid var(--line)}
  .gallery-hint{position:absolute;left:12px;bottom:12px;background:rgba(0,0,0,.55);color:#fff;
    font-size:12px;padding:6px 10px;border-radius:999px;backdrop-filter:blur(6px)}
  .gallery-thumbs{display:flex;gap:10px;overflow:auto;padding-bottom:2px}
  .thumb{flex:0 0 auto;border:1px solid var(--line);background:transparent;border-radius:14px;padding:0;cursor:pointer;overflow:hidden}
  .thumb img{width:110px;height:78px;object-fit:cover;display:block}
  .thumb.is-active{outline:2px solid var(--accent, #2e7d32);outline-offset:2px}
  .spec-grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px}
  @media (max-width: 740px){.spec-grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
  .spec{border:1px solid var(--line);border-radius:14px;padding:10px}
  .spec .k{font-size:12px;opacity:.75}
  .spec .v{font-weight:800;margin-top:4px}
  .price{font-size:32px;font-weight:950;margin-top:6px}
  .divider{height:1px;background:var(--line);margin:14px 0}
  .side-list{line-height:1.9;margin:0;padding-left:18px}
  .equip-list{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px 14px;line-height:1.5;padding-left:18px}
  @media (max-width: 620px){.equip-list{grid-template-columns:1fr}}
  .equip-list li.is-hidden{display:none}
  .sticky{position:sticky;top:92px}
  /* Lightbox */
  .lightbox{position:fixed;inset:0;display:none;z-index:1000}
  .lightbox.is-open{display:block}
  .lightbox-backdrop{position:absolute;inset:0;background:rgba(0,0,0,.72)}
  .lightbox-panel{position:relative;max-width:min(1100px,92vw);max-height:88vh;margin:6vh auto 0;
    display:flex;align-items:center;justify-content:center}
  .lightbox-img{max-width:92vw;max-height:82vh;border-radius:18px;border:1px solid rgba(255,255,255,.2)}
  .lightbox-close{position:absolute;top:-16px;right:-10px;border:0;background:rgba(255,255,255,.14);
    color:#fff;font-size:34px;line-height:1;border-radius:999px;width:46px;height:46px;cursor:pointer}
  .lightbox-nav{position:absolute;top:50%;transform:translateY(-50%);border:0;background:rgba(255,255,255,.14);
    color:#fff;font-size:44px;border-radius:16px;width:54px;height:54px;cursor:pointer}
  .lightbox-nav.prev{left:-12px}
  .lightbox-nav.next{right:-12px}
  .lightbox-count{position:absolute;bottom:-28px;left:50%;transform:translateX(-50%);color:#fff;opacity:.9}
</style>

<script is:inline>
  (() => {
    const bilder = Array.from(document.querySelectorAll('[data-thumb-index]'));
    const mainImg = document.getElementById('mainImage');
    const mainBtn = document.querySelector('[data-lightbox-open]');
    const lb = document.querySelector('[data-lightbox]');
    const lbImg = document.querySelector('[data-lightbox-img]');
    const lbCount = document.querySelector('[data-lightbox-count]');
    const closeBtns = document.querySelectorAll('[data-lightbox-close]');
    const prevBtn = document.querySelector('[data-lightbox-prev]');
    const nextBtn = document.querySelector('[data-lightbox-next]');
    const equipToggle = document.querySelector('[data-equip-toggle]');
    const equipList = document.querySelector('[data-equip-list]');
    let current = 0;

    const sources = bilder.map(b => b.querySelector('img')?.getAttribute('src')).filter(Boolean);

    function setActive(i){
      current = Math.max(0, Math.min(i, sources.length - 1));
      if (mainImg && sources[current]) mainImg.src = sources[current];
      bilder.forEach((b, idx) => b.classList.toggle('is-active', idx === current));
      if (lbCount) lbCount.textContent = sources.length ? (current + 1) + ' / ' + sources.length : '';
      if (lbImg && sources[current]) lbImg.src = sources[current];
    }

    bilder.forEach(btn => {
      btn.addEventListener('click', () => setActive(Number(btn.getAttribute('data-thumb-index')) || 0));
    });

    function openLb(){
      if (!lb || !lbImg) return;
      lb.classList.add('is-open');
      lb.setAttribute('aria-hidden', 'false');
      document.body.style.overflow = 'hidden';
      setActive(current);
    }
    function closeLb(){
      if (!lb) return;
      lb.classList.remove('is-open');
      lb.setAttribute('aria-hidden', 'true');
      document.body.style.overflow = '';
    }

    mainBtn?.addEventListener('click', openLb);
    closeBtns.forEach(b => b.addEventListener('click', closeLb));
    prevBtn?.addEventListener('click', () => setActive(current - 1));
    nextBtn?.addEventListener('click', () => setActive(current + 1));

    window.addEventListener('keydown', (e) => {
      if (!lb?.classList.contains('is-open')) return;
      if (e.key === 'Escape') closeLb();
      if (e.key === 'ArrowLeft') setActive(current - 1);
      if (e.key === 'ArrowRight') setActive(current + 1);
    });

    // Ausstattung: Mehr/Weniger
    if (equipToggle && equipList) {
      let expanded = false;
      const hiddenItems = Array.from(equipList.querySelectorAll('li.is-hidden'));
      const apply = () => {
        hiddenItems.forEach(li => (li.style.display = expanded ? 'list-item' : 'none'));
        equipToggle.textContent = expanded ? 'Weniger anzeigen' : 'Mehr anzeigen';
      };
      equipToggle.addEventListener('click', () => {
        expanded = !expanded;
        apply();
      });
      apply();
    }

    // initial
    if (bilder.length) setActive(0);
  })();
</script>

</BaseLayout>
